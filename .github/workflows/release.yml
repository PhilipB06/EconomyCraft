name: Release to Modrinth & CurseForge

on:
  workflow_dispatch:
    inputs:
      release_version:
        description: "Mod version"
        required: true
        type: string

jobs:
  build:
    name: Build (${{ matrix.platform }} ${{ matrix.mc_game }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        platform: [fabric, neoforge]
        mc_game:
          - "1.21"
          - "1.21.1"
          - "1.21.2"
          - "1.21.3"
          - "1.21.4"
          - "1.21.5"
          - "1.21.6"
          - "1.21.7"
          - "1.21.8"
          - "1.21.9"
          - "1.21.10"
          - "1.21.11"

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 21

      - uses: gradle/actions/setup-gradle@v4

      - name: Build jar
        shell: bash
        run: |
          set -euo pipefail

          MC_GAME="${{ matrix.mc_game }}"
          MC_TASK="$MC_GAME"

          if [[ "$MC_GAME" =~ ^([0-9]+\.[0-9]+)\.([0-9]+)$ ]]; then
            base="${BASH_REMATCH[1]}"
            patch="${BASH_REMATCH[2]}"
            if (( patch < 10 )); then patch="0$patch"; fi
            MC_TASK="$base.$patch"
          fi

          mkdir -p out

          if [ "${{ matrix.platform }}" = "fabric" ]; then
            ./gradlew "buildAndCopyFabricJars_${MC_TASK}" -Pfilter_platforms=fabric
            cp fabric/build/libs/*_"$MC_GAME".jar out/
          else
            ./gradlew "buildAndCopyNeoForgeJars_${MC_TASK}" -Pfilter_platforms=neoforge
            cp neoforge/build/libs/*_"$MC_GAME".jar out/
          fi

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.platform }}-${{ matrix.mc_game }}
          path: out/*.jar
          if-no-files-found: error

  publish:
    name: Publish (ordered)
    runs-on: ubuntu-latest
    needs: build

    steps:
      - uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      # -------------------------
      #     NEOFORGE BUILDS
      # -------------------------
      - name: Publish NeoForge 1.21
        uses: Kir-Antipov/mc-publish@v3.3
        with:
          modrinth-id: H4o5bO7g
          curseforge-id: 1321557
          modrinth-token: ${{ secrets.MODRINTH_PERSONAL_ACCESS_TOKEN }}
          curseforge-token: ${{ secrets.CURSEFORGE_PERSONAL_ACCESS_TOKEN }}
          version: ${{ inputs.release_version }}
          name: EconomyCraft ${{ inputs.release_version }} - NeoForge - 1.21
          version-type: release
          changelog-file: CHANGELOG.md
          game-versions: 1.21
          dependencies: |
            architectury-api | depends
          files: |
            artifacts/neoforge-1.21/*.jar

      - name: Publish NeoForge 1.21.1
        uses: Kir-Antipov/mc-publish@v3.3
        with:
          modrinth-id: H4o5bO7g
          curseforge-id: 1321557
          modrinth-token: ${{ secrets.MODRINTH_PERSONAL_ACCESS_TOKEN }}
          curseforge-token: ${{ secrets.CURSEFORGE_PERSONAL_ACCESS_TOKEN }}
          version: ${{ inputs.release_version }}
          name: EconomyCraft ${{ inputs.release_version }} - NeoForge - 1.21.1
          version-type: release
          changelog-file: CHANGELOG.md
          game-versions: 1.21.1
          dependencies: |
            architectury-api | depends
          files: |
            artifacts/neoforge-1.21.1/*.jar

      - name: Publish NeoForge 1.21.2
        uses: Kir-Antipov/mc-publish@v3.3
        with:
          modrinth-id: H4o5bO7g
          curseforge-id: 1321557
          modrinth-token: ${{ secrets.MODRINTH_PERSONAL_ACCESS_TOKEN }}
          curseforge-token: ${{ secrets.CURSEFORGE_PERSONAL_ACCESS_TOKEN }}
          version: ${{ inputs.release_version }}
          name: EconomyCraft ${{ inputs.release_version }} - NeoForge - 1.21.2
          version-type: release
          changelog-file: CHANGELOG.md
          game-versions: 1.21.2
          dependencies: |
            architectury-api | depends
          files: |
            artifacts/neoforge-1.21.2/*.jar

      - name: Publish NeoForge 1.21.3
        uses: Kir-Antipov/mc-publish@v3.3
        with:
          modrinth-id: H4o5bO7g
          curseforge-id: 1321557
          modrinth-token: ${{ secrets.MODRINTH_PERSONAL_ACCESS_TOKEN }}
          curseforge-token: ${{ secrets.CURSEFORGE_PERSONAL_ACCESS_TOKEN }}
          version: ${{ inputs.release_version }}
          name: EconomyCraft ${{ inputs.release_version }} - NeoForge - 1.21.3
          version-type: release
          changelog-file: CHANGELOG.md
          game-versions: 1.21.3
          dependencies: |
            architectury-api | depends
          files: |
            artifacts/neoforge-1.21.3/*.jar

      - name: Publish NeoForge 1.21.4
        uses: Kir-Antipov/mc-publish@v3.3
        with:
          modrinth-id: H4o5bO7g
          curseforge-id: 1321557
          modrinth-token: ${{ secrets.MODRINTH_PERSONAL_ACCESS_TOKEN }}
          curseforge-token: ${{ secrets.CURSEFORGE_PERSONAL_ACCESS_TOKEN }}
          version: ${{ inputs.release_version }}
          name: EconomyCraft ${{ inputs.release_version }} - NeoForge - 1.21.4
          version-type: release
          changelog-file: CHANGELOG.md
          game-versions: 1.21.4
          dependencies: |
            architectury-api | depends
          files: |
            artifacts/neoforge-1.21.4/*.jar

      - name: Publish NeoForge 1.21.5
        uses: Kir-Antipov/mc-publish@v3.3
        with:
          modrinth-id: H4o5bO7g
          curseforge-id: 1321557
          modrinth-token: ${{ secrets.MODRINTH_PERSONAL_ACCESS_TOKEN }}
          curseforge-token: ${{ secrets.CURSEFORGE_PERSONAL_ACCESS_TOKEN }}
          version: ${{ inputs.release_version }}
          name: EconomyCraft ${{ inputs.release_version }} - NeoForge - 1.21.5
          version-type: release
          changelog-file: CHANGELOG.md
          game-versions: 1.21.5
          dependencies: |
            architectury-api | depends
          files: |
            artifacts/neoforge-1.21.5/*.jar

      - name: Publish NeoForge 1.21.6
        uses: Kir-Antipov/mc-publish@v3.3
        with:
          modrinth-id: H4o5bO7g
          curseforge-id: 1321557
          modrinth-token: ${{ secrets.MODRINTH_PERSONAL_ACCESS_TOKEN }}
          curseforge-token: ${{ secrets.CURSEFORGE_PERSONAL_ACCESS_TOKEN }}
          version: ${{ inputs.release_version }}
          name: EconomyCraft ${{ inputs.release_version }} - NeoForge - 1.21.6
          version-type: release
          changelog-file: CHANGELOG.md
          game-versions: 1.21.6
          dependencies: |
            architectury-api | depends
          files: |
            artifacts/neoforge-1.21.6/*.jar

      - name: Publish NeoForge 1.21.7
        uses: Kir-Antipov/mc-publish@v3.3
        with:
          modrinth-id: H4o5bO7g
          curseforge-id: 1321557
          modrinth-token: ${{ secrets.MODRINTH_PERSONAL_ACCESS_TOKEN }}
          curseforge-token: ${{ secrets.CURSEFORGE_PERSONAL_ACCESS_TOKEN }}
          version: ${{ inputs.release_version }}
          name: EconomyCraft ${{ inputs.release_version }} - NeoForge - 1.21.7
          version-type: release
          changelog-file: CHANGELOG.md
          game-versions: 1.21.7
          dependencies: |
            architectury-api | depends
          files: |
            artifacts/neoforge-1.21.7/*.jar

      - name: Publish NeoForge 1.21.8
        uses: Kir-Antipov/mc-publish@v3.3
        with:
          modrinth-id: H4o5bO7g
          curseforge-id: 1321557
          modrinth-token: ${{ secrets.MODRINTH_PERSONAL_ACCESS_TOKEN }}
          curseforge-token: ${{ secrets.CURSEFORGE_PERSONAL_ACCESS_TOKEN }}
          version: ${{ inputs.release_version }}
          name: EconomyCraft ${{ inputs.release_version }} - NeoForge - 1.21.8
          version-type: release
          changelog-file: CHANGELOG.md
          game-versions: 1.21.8
          dependencies: |
            architectury-api | depends
          files: |
            artifacts/neoforge-1.21.8/*.jar

      - name: Publish NeoForge 1.21.9
        uses: Kir-Antipov/mc-publish@v3.3
        with:
          modrinth-id: H4o5bO7g
          curseforge-id: 1321557
          modrinth-token: ${{ secrets.MODRINTH_PERSONAL_ACCESS_TOKEN }}
          curseforge-token: ${{ secrets.CURSEFORGE_PERSONAL_ACCESS_TOKEN }}
          version: ${{ inputs.release_version }}
          name: EconomyCraft ${{ inputs.release_version }} - NeoForge - 1.21.9
          version-type: release
          changelog-file: CHANGELOG.md
          game-versions: 1.21.9
          dependencies: |
            architectury-api | depends
          files: |
            artifacts/neoforge-1.21.9/*.jar

      - name: Publish NeoForge 1.21.10
        uses: Kir-Antipov/mc-publish@v3.3
        with:
          modrinth-id: H4o5bO7g
          curseforge-id: 1321557
          modrinth-token: ${{ secrets.MODRINTH_PERSONAL_ACCESS_TOKEN }}
          curseforge-token: ${{ secrets.CURSEFORGE_PERSONAL_ACCESS_TOKEN }}
          version: ${{ inputs.release_version }}
          name: EconomyCraft ${{ inputs.release_version }} - NeoForge - 1.21.10
          version-type: release
          changelog-file: CHANGELOG.md
          game-versions: 1.21.10
          dependencies: |
            architectury-api | depends
          files: |
            artifacts/neoforge-1.21.10/*.jar

      - name: Publish NeoForge 1.21.11
        uses: Kir-Antipov/mc-publish@v3.3
        with:
          modrinth-id: H4o5bO7g
          curseforge-id: 1321557
          modrinth-token: ${{ secrets.MODRINTH_PERSONAL_ACCESS_TOKEN }}
          curseforge-token: ${{ secrets.CURSEFORGE_PERSONAL_ACCESS_TOKEN }}
          version: ${{ inputs.release_version }}
          name: EconomyCraft ${{ inputs.release_version }} - NeoForge - 1.21.11
          version-type: release
          changelog-file: CHANGELOG.md
          game-versions: 1.21.11
          dependencies: |
            architectury-api | depends
          files: |
            artifacts/neoforge-1.21.11/*.jar

      # -------------------------
      #     FABRIC BUILDS
      # -------------------------
      - name: Publish Fabric 1.21
        uses: Kir-Antipov/mc-publish@v3.3
        with:
          modrinth-id: H4o5bO7g
          curseforge-id: 1321557
          modrinth-token: ${{ secrets.MODRINTH_PERSONAL_ACCESS_TOKEN }}
          curseforge-token: ${{ secrets.CURSEFORGE_PERSONAL_ACCESS_TOKEN }}
          version: ${{ inputs.release_version }}
          name: EconomyCraft ${{ inputs.release_version }} - Fabric - 1.21
          version-type: release
          changelog-file: CHANGELOG.md
          game-versions: 1.21
          dependencies: |
            architectury-api | depends
          files: |
            artifacts/fabric-1.21/*.jar

      - name: Publish Fabric 1.21.1
        uses: Kir-Antipov/mc-publish@v3.3
        with:
          modrinth-id: H4o5bO7g
          curseforge-id: 1321557
          modrinth-token: ${{ secrets.MODRINTH_PERSONAL_ACCESS_TOKEN }}
          curseforge-token: ${{ secrets.CURSEFORGE_PERSONAL_ACCESS_TOKEN }}
          version: ${{ inputs.release_version }}
          name: EconomyCraft ${{ inputs.release_version }} - Fabric - 1.21.1
          version-type: release
          changelog-file: CHANGELOG.md
          game-versions: 1.21.1
          dependencies: |
            architectury-api | depends
          files: |
            artifacts/fabric-1.21.1/*.jar

      - name: Publish Fabric 1.21.2
        uses: Kir-Antipov/mc-publish@v3.3
        with:
          modrinth-id: H4o5bO7g
          curseforge-id: 1321557
          modrinth-token: ${{ secrets.MODRINTH_PERSONAL_ACCESS_TOKEN }}
          curseforge-token: ${{ secrets.CURSEFORGE_PERSONAL_ACCESS_TOKEN }}
          version: ${{ inputs.release_version }}
          name: EconomyCraft ${{ inputs.release_version }} - Fabric - 1.21.2
          version-type: release
          changelog-file: CHANGELOG.md
          game-versions: 1.21.2
          dependencies: |
            architectury-api | depends
          files: |
            artifacts/fabric-1.21.2/*.jar

      - name: Publish Fabric 1.21.3
        uses: Kir-Antipov/mc-publish@v3.3
        with:
          modrinth-id: H4o5bO7g
          curseforge-id: 1321557
          modrinth-token: ${{ secrets.MODRINTH_PERSONAL_ACCESS_TOKEN }}
          curseforge-token: ${{ secrets.CURSEFORGE_PERSONAL_ACCESS_TOKEN }}
          version: ${{ inputs.release_version }}
          name: EconomyCraft ${{ inputs.release_version }} - Fabric - 1.21.3
          version-type: release
          changelog-file: CHANGELOG.md
          game-versions: 1.21.3
          dependencies: |
            architectury-api | depends
          files: |
            artifacts/fabric-1.21.3/*.jar

      - name: Publish Fabric 1.21.4
        uses: Kir-Antipov/mc-publish@v3.3
        with:
          modrinth-id: H4o5bO7g
          curseforge-id: 1321557
          modrinth-token: ${{ secrets.MODRINTH_PERSONAL_ACCESS_TOKEN }}
          curseforge-token: ${{ secrets.CURSEFORGE_PERSONAL_ACCESS_TOKEN }}
          version: ${{ inputs.release_version }}
          name: EconomyCraft ${{ inputs.release_version }} - Fabric - 1.21.4
          version-type: release
          changelog-file: CHANGELOG.md
          game-versions: 1.21.4
          dependencies: |
            architectury-api | depends
          files: |
            artifacts/fabric-1.21.4/*.jar

      - name: Publish Fabric 1.21.5
        uses: Kir-Antipov/mc-publish@v3.3
        with:
          modrinth-id: H4o5bO7g
          curseforge-id: 1321557
          modrinth-token: ${{ secrets.MODRINTH_PERSONAL_ACCESS_TOKEN }}
          curseforge-token: ${{ secrets.CURSEFORGE_PERSONAL_ACCESS_TOKEN }}
          version: ${{ inputs.release_version }}
          name: EconomyCraft ${{ inputs.release_version }} - Fabric - 1.21.5
          version-type: release
          changelog-file: CHANGELOG.md
          game-versions: 1.21.5
          dependencies: |
            architectury-api | depends
          files: |
            artifacts/fabric-1.21.5/*.jar

      - name: Publish Fabric 1.21.6
        uses: Kir-Antipov/mc-publish@v3.3
        with:
          modrinth-id: H4o5bO7g
          curseforge-id: 1321557
          modrinth-token: ${{ secrets.MODRINTH_PERSONAL_ACCESS_TOKEN }}
          curseforge-token: ${{ secrets.CURSEFORGE_PERSONAL_ACCESS_TOKEN }}
          version: ${{ inputs.release_version }}
          name: EconomyCraft ${{ inputs.release_version }} - Fabric - 1.21.6
          version-type: release
          changelog-file: CHANGELOG.md
          game-versions: 1.21.6
          dependencies: |
            architectury-api | depends
          files: |
            artifacts/fabric-1.21.6/*.jar

      - name: Publish Fabric 1.21.7
        uses: Kir-Antipov/mc-publish@v3.3
        with:
          modrinth-id: H4o5bO7g
          curseforge-id: 1321557
          modrinth-token: ${{ secrets.MODRINTH_PERSONAL_ACCESS_TOKEN }}
          curseforge-token: ${{ secrets.CURSEFORGE_PERSONAL_ACCESS_TOKEN }}
          version: ${{ inputs.release_version }}
          name: EconomyCraft ${{ inputs.release_version }} - Fabric - 1.21.7
          version-type: release
          changelog-file: CHANGELOG.md
          game-versions: 1.21.7
          dependencies: |
            architectury-api | depends
          files: |
            artifacts/fabric-1.21.7/*.jar

      - name: Publish Fabric 1.21.8
        uses: Kir-Antipov/mc-publish@v3.3
        with:
          modrinth-id: H4o5bO7g
          curseforge-id: 1321557
          modrinth-token: ${{ secrets.MODRINTH_PERSONAL_ACCESS_TOKEN }}
          curseforge-token: ${{ secrets.CURSEFORGE_PERSONAL_ACCESS_TOKEN }}
          version: ${{ inputs.release_version }}
          name: EconomyCraft ${{ inputs.release_version }} - Fabric - 1.21.8
          version-type: release
          changelog-file: CHANGELOG.md
          game-versions: 1.21.8
          dependencies: |
            architectury-api | depends
          files: |
            artifacts/fabric-1.21.8/*.jar

      - name: Publish Fabric 1.21.9
        uses: Kir-Antipov/mc-publish@v3.3
        with:
          modrinth-id: H4o5bO7g
          curseforge-id: 1321557
          modrinth-token: ${{ secrets.MODRINTH_PERSONAL_ACCESS_TOKEN }}
          curseforge-token: ${{ secrets.CURSEFORGE_PERSONAL_ACCESS_TOKEN }}
          version: ${{ inputs.release_version }}
          name: EconomyCraft ${{ inputs.release_version }} - Fabric - 1.21.9
          version-type: release
          changelog-file: CHANGELOG.md
          game-versions: 1.21.9
          dependencies: |
            architectury-api | depends
          files: |
            artifacts/fabric-1.21.9/*.jar

      - name: Publish Fabric 1.21.10
        uses: Kir-Antipov/mc-publish@v3.3
        with:
          modrinth-id: H4o5bO7g
          curseforge-id: 1321557
          modrinth-token: ${{ secrets.MODRINTH_PERSONAL_ACCESS_TOKEN }}
          curseforge-token: ${{ secrets.CURSEFORGE_PERSONAL_ACCESS_TOKEN }}
          version: ${{ inputs.release_version }}
          name: EconomyCraft ${{ inputs.release_version }} - Fabric - 1.21.10
          version-type: release
          changelog-file: CHANGELOG.md
          game-versions: 1.21.10
          dependencies: |
            architectury-api | depends
          files: |
            artifacts/fabric-1.21.10/*.jar

      - name: Publish Fabric 1.21.11
        uses: Kir-Antipov/mc-publish@v3.3
        with:
          modrinth-id: H4o5bO7g
          curseforge-id: 1321557
          modrinth-token: ${{ secrets.MODRINTH_PERSONAL_ACCESS_TOKEN }}
          curseforge-token: ${{ secrets.CURSEFORGE_PERSONAL_ACCESS_TOKEN }}
          version: ${{ inputs.release_version }}
          name: EconomyCraft ${{ inputs.release_version }} - Fabric - 1.21.11
          version-type: release
          changelog-file: CHANGELOG.md
          game-versions: 1.21.11
          dependencies: |
            architectury-api | depends
          files: |
            artifacts/fabric-1.21.11/*.jar
